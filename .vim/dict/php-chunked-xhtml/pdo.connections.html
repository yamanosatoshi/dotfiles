<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <title>接続、および接続の管理</title>
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-base.css" />
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-medium.css" />

 </head>
 <body class="docs"><div class="navbar navbar-fixed-top">
  <div class="navbar-inner clearfix">
    <ul class="nav" style="width: 100%">
      <li style="float: left;"><a href="pdo.constants.html">« 定義済み定数</a></li>
      <li style="float: right;"><a href="pdo.transactions.html">トランザクションおよび自動コミット »</a></li>
    </ul>
  </div>
</div>
<div id="breadcrumbs" class="clearfix">
  <ul class="breadcrumbs-container">
    <li><a href="index.html">PHP Manual</a></li>
    <li><a href="book.pdo.html">PDO</a></li>
    <li>接続、および接続の管理</li>
  </ul>
</div>
<div id="layout">
  <div id="layout-content"><div id="pdo.connections" class="chapter">
  <h1>接続、および接続の管理</h1>

 <p class="para">
  PDO 基底クラスのインスタンスを作成することにより、接続が確立されます。
  どのドライバを使用するのかにかかわらず、常に PDO クラスを指定します。
  コンストラクタに渡す引数により、データソース (いわゆる DSN) の指定や
  (もしあれば、オプションで) ユーザー名およびパスワードの指定を行います。
 </p>
 <p class="para">
  <div class="example" id="example-948">
   <p><strong>例1 MySQL への接続</strong></p>
   <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br />$dbh&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">PDO</span><span style="color: #007700">(</span><span style="color: #DD0000">'mysql:host=localhost;dbname=test'</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$user</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$pass</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div> 
   </div>

  </div>
 </p>
 <p class="para">
  接続時になんらかのエラーが発生した場合、<code class="literal">PDOException</code>
  オブジェクトがスローされます。エラー処理を行いたい場合はこの例外を
  キャッチします。あるいはこれを無視して、
  <span class="function"><a href="function.set-exception-handler.html" class="function">set_exception_handler()</a></span> で設定した
  グローバル例外ハンドラに処理を任せることもできます。
 </p>
 <p class="para">
  <div class="example" id="odbc-data-source.example.basic"><p><strong>例2 接続エラーの処理</strong></p>
   <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /></span><span style="color: #007700">try&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$dbh&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">PDO</span><span style="color: #007700">(</span><span style="color: #DD0000">'mysql:host=localhost;dbname=test'</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$user</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$pass</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;foreach(</span><span style="color: #0000BB">$dbh</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">(</span><span style="color: #DD0000">'SELECT&nbsp;*&nbsp;from&nbsp;FOO'</span><span style="color: #007700">)&nbsp;as&nbsp;</span><span style="color: #0000BB">$row</span><span style="color: #007700">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">print_r</span><span style="color: #007700">(</span><span style="color: #0000BB">$row</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$dbh&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">null</span><span style="color: #007700">;<br />}&nbsp;catch&nbsp;(</span><span style="color: #0000BB">PDOException&nbsp;$e</span><span style="color: #007700">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;print&nbsp;</span><span style="color: #DD0000">"エラー!:&nbsp;"&nbsp;</span><span style="color: #007700">.&nbsp;</span><span style="color: #0000BB">$e</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">getMessage</span><span style="color: #007700">()&nbsp;.&nbsp;</span><span style="color: #DD0000">"&lt;br/&gt;"</span><span style="color: #007700">;<br />&nbsp;&nbsp;&nbsp;&nbsp;die();<br />}<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
   </div>

  </div>
 </p>
 <div class="warning"><strong class="warning">警告</strong>
  <p class="para">
   PDO コンストラクタからの例外をアプリケーション内でキャッチしない場合、
   zend エンジンはスクリプトの実行を終了し、バックトレースを表示します。
   このバックトレースを見れば、データベースへの接続の詳細がわかってしまいます。
   その中にはユーザー名やパスワードも含まれます。
   (<code class="literal">catch</code> 文を使用して) 明示的に例外をキャッチするか、
   あるいは <span class="function"><a href="function.set-exception-handler.html" class="function">set_exception_handler()</a></span> を使用して
   暗黙的に例外をキャッチするようにしましょう。
  </p>
 </div>
 <p class="para">
  データベースへの接続に成功すると、PDO クラスのインスタンスが
  スクリプトに返されます。この PDO オブジェクトが存在する間、
  接続がアクティブであり続けます。接続を閉じるには、他から
  参照されていないことを保障することでオブジェクトを破棄する
  必要があります。それには、オブジェクトを保持している変数に対して
  <strong><code>null</code></strong> を代入します。
  明示的にこれを行わなかった場合は、スクリプトの終了時に自動的に
  接続が閉じられます。
 </p>
 <blockquote class="note"><p><strong class="note">注意</strong>: 
  <span class="simpara">
   この PDO インスタンスへの参照
   (PDOStatement インスタンスからの参照や、同じ PDO インスタンスを参照する別の変数からの参照など)
   が他にも残っているなら、それらもあわせて削除する必要があります
   (PDOStatement を参照する変数に <strong><code>null</code></strong> を代入するなど)。
  </span>
 </p></blockquote>
 <p class="para">
  <div class="example" id="example-950">
   <p><strong>例3 接続を閉じる</strong></p>
   <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br />$dbh&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">PDO</span><span style="color: #007700">(</span><span style="color: #DD0000">'mysql:host=localhost;dbname=test'</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$user</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$pass</span><span style="color: #007700">);<br /></span><span style="color: #FF8000">//&nbsp;ここで接続を使用します<br /></span><span style="color: #0000BB">$sth&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$dbh</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">(</span><span style="color: #DD0000">'SELECT&nbsp;*&nbsp;FROM&nbsp;foo'</span><span style="color: #007700">);<br /><br /></span><span style="color: #FF8000">//&nbsp;使用を終了したので、閉じます<br /></span><span style="color: #0000BB">$sth&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">null</span><span style="color: #007700">;<br /></span><span style="color: #0000BB">$dbh&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">null</span><span style="color: #007700">;<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
   </div>

  </div>
 </p>
 <p class="para">
  データベースサーバーへの持続的な接続による恩恵をこうむる web
  アプリケーションは多いでしょう。持続的な接続は、スクリプトが
  終了しても閉じられずにキャッシュされ、他のスクリプトが同じ内容の
  接続を要求してきた際にそれが再利用されます。持続的接続の
  キャッシュにより、スクリプトがデータベースを使用するたびに
  新しい接続を確立するオーバーヘッドを避けることができます。
  それにより、結果として web アプリケーションを高速化できるように
  なります。
 </p>
 <p class="para">
  <div class="example" id="example-951">
   <p><strong>例4 持続的な接続</strong></p>
   <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br />$dbh&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">PDO</span><span style="color: #007700">(</span><span style="color: #DD0000">'mysql:host=localhost;dbname=test'</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$user</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$pass</span><span style="color: #007700">,&nbsp;array(<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">PDO</span><span style="color: #007700">::</span><span style="color: #0000BB">ATTR_PERSISTENT&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">true<br /></span><span style="color: #007700">));<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
   </div>

  </div>
 </p>
 <p class="para">
  <strong><code>PDO::ATTR_PERSISTENT</code></strong> オプションの値は、
  数値でない <span class="type">string</span> の値が設定されない限り、(持続的な接続が有効/無効かを示す)
  <span class="type">bool</span> に変換されます。
  数値でない <span class="type">string</span> を設定する場合、複数の接続プールを使うことができます。
  これは互換性がない異なる接続設定を使う場合に便利です。たとえば、
  異なる <strong><code>PDO::MYSQL_ATTR_USE_BUFFERED_QUERY</code></strong> の値を設定する場合が挙げられます。
 </p>
 <blockquote class="note"><p><strong class="note">注意</strong>: 
  <p class="para">
   持続的な接続を使用したい場合は、ドライバのオプションを表す配列に
   <strong><code>PDO::ATTR_PERSISTENT</code></strong> を設定して
   PDO のコンストラクタに渡す必要があります。この属性を
   <span class="function"><a href="pdo.setattribute.html" class="function">PDO::setAttribute()</a></span>
   を用いてインスタンス作成後に設定した場合は、
   そのドライバは持続的な接続を使用しません。
  </p>
 </p></blockquote>
 <blockquote class="note"><p><strong class="note">注意</strong>: 
  <p class="para">
   PDO ODBC ドライバを使用しており、ODBC ライブラリが ODBC
   接続プーリングをサポートしている場合 (unixODBC および Windows
   はこれをサポートしています。他にもあるかもしれません) は、
   PDO の持続的接続を使用せずに ODBC の接続プーリングに
   接続キャッシュ処理を任せることを推奨します。
   ODBC の接続プールは、プロセス内で他のモジュールと共有されています。
   PDO が接続をキャッシュしてしまうと、その接続は ODBC の
   接続プールに返されなくなり、他のモジュールによって新たな接続が
   作成されてしまうようになります。
  </p>
 </p></blockquote>
</div>
</div></div></body></html>